<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flora - Tienda de Flores</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --rosa:#e6a5b6; --rosa-osc:#c97b94; --bg:#fdfaf7; 
      --gris:#5c5c5c; --borde:#ecd6dc; --sombra:rgba(0,0,0,0.08);
    }
    *{ box-sizing:border-box; }
    body {
      margin:0; font-family:'Inter', sans-serif;
      background:var(--bg); color:#333; display:flex; flex-direction:column;
    }
    header {
      text-align:center; padding:20px 16px;
    }
    header img {
      max-width:220px; height:auto; display:block; margin:0 auto 8px;
    }
    header h2 {
      margin:8px 0 0; color:var(--gris);
    }
    .view{ display:none; padding:16px; animation:fade .25s ease }
    .view.active{ display:block }
    @keyframes fade{ from{opacity:.35;transform:translateY(4px)} to{opacity:1;transform:none} }

    /* ---- FORMULARIO ---- */
    form {
      background:#fff; border:1px solid var(--borde);
      border-radius:20px; max-width:800px; margin:20px auto;
      padding:28px; box-shadow:0 8px 24px var(--sombra);
      transition:box-shadow 0.3s ease;
    }
    form:hover { box-shadow:0 12px 32px rgba(0,0,0,0.12); }
    h3 {
      border-bottom:2px solid var(--rosa);
      padding-bottom:6px; margin:20px 0 18px;
      color:var(--rosa-osc); font-size:1.1rem;
    }
    label{ font-size:.92rem; color:#444; font-weight:600; }
    input, select, textarea {
      width:100%; padding:12px 14px; border:1px solid #d9d9d9;
      border-radius:10px; font-size:.95rem; background:#fff;
      transition:border-color .25s ease, box-shadow .25s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color:var(--rosa);
      box-shadow:0 0 0 3px rgba(230,165,182,0.2);
      outline:none;
    }
    textarea { min-height:90px; resize:vertical; }

    .grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
    .grid-1 { grid-template-columns:1fr; }
    .pill {
      display:inline-block; padding:8px 12px;
      border-radius:999px; background:#fff3f6;
      border:1px solid var(--rosa); color:#b35a74; font-weight:700;
    }
    .badge{ display:inline-block; padding:6px 10px; border-radius:999px;
      font-size:.85rem; margin-left:8px }
    .ok{ background:#e7f8ec; color:#1a7f37; border:1px solid #bfe7c8 }
    .warn{ background:#fff7e6; color:#a15d00; border:1px solid #ffd59e }
    .hidden{ display:none; }

    .pedido-summary {
      background:#fff3f6; border:1px solid var(--borde);
      border-radius:12px; padding:10px 16px; margin-bottom:16px;
      font-weight:600; color:#a34b6d;
    }

    .actions {
      display:flex; justify-content:space-between; margin-top:20px; gap:12px;
    }
    .btn-primary {
      background:var(--rosa); color:#fff; border:none;
      border-radius:10px; padding:12px 22px; font-weight:800;
      cursor:pointer; transition:background .3s;
    }
    .btn-primary:hover { background:var(--rosa-osc); }
    .btn-outline {
      background:#fff; border:2px solid var(--rosa);
      color:var(--rosa); border-radius:10px;
      padding:12px 22px; font-weight:700; cursor:pointer;
      transition:background .3s,color .3s;
    }
    .btn-outline:hover {
      background:var(--rosa); color:#fff;
    }
    #status{ text-align:center; margin-top:10px; font-weight:700 }
    .err{ color:#b00020 } .good{ color:green }

    @media(max-width:600px){
      form{ padding:20px; border-radius:14px; }
      .actions{ flex-direction:column; }
    }
  </style>
</head>
<body>
  <header>
    <img src="img/logo 2024 marca registrada-04.png" alt="FLORA Logo"/>
    <h2>Cat√°logo de Arreglos Florales</h2>
  </header>

  <section id="viewCatalog" class="view active">
    <div id="catalogo" class="catalogo"></div>
  </section>

  <!-- ==== FORMULARIO MEJORADO ==== -->
  <section id="viewForm" class="view">
    <form id="pedidoForm">
      <div class="pedido-summary" id="resumenProducto">üõç Producto: ‚Äî</div>
      <span id="badgeCliente" class="badge warn hidden">Nuevo cliente</span>

      <h3>Datos del Cliente</h3>
      <div class="grid">
        <div>
          <label>Tipo de identificaci√≥n</label>
          <select id="tipoIdent" name="tipoIdent" required>
            <option value="CEDULA" selected>C√©dula</option>
            <option value="NIT">NIT</option>
          </select>
        </div>
        <div><label>Identificaci√≥n</label><input id="identificacion" name="identificacion" placeholder="C√©dula / NIT" required></div>
        <div><label>Tel√©fono</label><input id="telefono" name="telefono" placeholder="Ej: 3001234567" required></div>
        <div><label>Nombre</label><input id="primerNombre" name="primerNombre" required></div>
        <div id="apellidoWrapper"><label>Apellido(s)</label><input id="primerApellido" name="primerApellido"></div>
        <div id="emailWrapper"><label>Email (opcional)</label><input type="email" id="email" name="email" placeholder="ejemplo@email.com"></div>
      </div>

      <h3>Detalles de Entrega</h3>
      <div class="grid">
        <div><label>Destinatario</label><input id="destinatario" name="destinatario" required></div>
        <div><label>Tel√©fono destino</label><input id="telefonoDestino" name="telefonoDestino" placeholder="Ej: 3201234567" required></div>
        <div><label>Direcci√≥n</label><input id="direccion" name="direccion" placeholder="Direcci√≥n, Casa, Torre, Apto" required></div>
        <div><label>Barrio</label><select id="barrio" name="barrio"></select></div>
        <div><label>Fecha de entrega</label><input id="fechaEntrega" name="fechaEntrega" type="date" required></div>
        <div><label>Hora de entrega</label><input id="horaEntrega" name="horaEntrega" type="time" required></div>
      </div>

      <h3>Pago y Mensaje</h3>
      <div class="grid">
        <div>
          <label>Medio de pago</label>
          <select id="formaPago" name="formaPago" required>
            <option value="">Selecciona‚Ä¶</option>
            <option value="TRANSFERENCIA">Transferencia</option>
            <option value="TARJETA">Tarjeta</option>
            <option value="LINK">Link</option>
            <option value="EFECTIVO">Efectivo</option>
            <option value="CUENTAS POR COBRAR">Cuentas Por Cobrar</option>
            <option value="CONTRAENTREGA">Contraentrega</option>
          </select>
        </div>
        <div class="grid-1">
          <label>Mensaje</label>
          <textarea id="mensaje" name="mensaje" placeholder="Escribe un mensaje opcional para acompa√±ar el pedido"></textarea>
        </div>
      </div>

      <!-- Campos ocultos -->
      <input type="hidden" id="producto" name="producto">
      <input type="hidden" id="precio" name="precio">
      <input type="hidden" id="cantidad" name="cantidad">
      <input type="hidden" id="domicilio" name="domicilio">
      <input type="hidden" id="iva" name="iva">
      <input type="hidden" id="total" name="total">
      <input type="hidden" id="fechaEntregaFinal" name="fechaEntregaFinal">
      <input type="hidden" id="horaEntregaFinal" name="horaEntregaFinal">

      <div class="actions">
        <button type="button" class="btn-outline" id="btnVolver">Regresar al cat√°logo</button>
        <button type="submit" class="btn-primary" id="btnSubmit">Confirmar pedido</button>
      </div>
      <div id="status"></div>
    </form>
  </section>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwol802NzgXkLtWVJiDLX_MnOXlyyWxL0AnVVef1GO8L7TVYAI5uH_6jkJomakcWlih/exec";
    const state = { catalogo: [], cart: [], barrios: {} };
    const fmtCOP = v => Number(v||0).toLocaleString('es-CO');

    async function init(){
      const res = await fetch(SCRIPT_URL);
      const data = await res.json();
      state.catalogo = data.catalogo || [];
      state.barrios  = data.barrios  || {};
      renderCatalog(state.catalogo);
      fillBarrios(state.barrios);
      document.getElementById('fechaEntrega').setAttribute('min', new Date().toISOString().slice(0,10));
    }

    function fillBarrios(map){
      const sel=document.getElementById('barrio');
      sel.innerHTML='<option value="">Selecciona‚Ä¶</option>';
      Object.keys(map).forEach(n=>{
        const opt=document.createElement('option');
        opt.value=n; opt.textContent=n; sel.appendChild(opt);
      });
    }

    // --- Env√≠o del pedido con SweetAlert2 ---
    document.getElementById("pedidoForm").addEventListener("submit", async e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const fecha = document.getElementById("fechaEntrega").value;
      const hora  = document.getElementById("horaEntrega").value;
      if (fecha) fd.set("fechaEntregaFinal", fecha);
      if (hora)  fd.set("horaEntregaFinal", hora);

      const btn=document.getElementById("btnSubmit");
      btn.disabled=true; btn.textContent="Procesando... ‚è≥";

      try{
        const res=await fetch(SCRIPT_URL,{method:"POST",body:fd});
        const data=await res.json();

        if(data.status==="success"){
          Swal.fire({
            title:"¬°Pedido confirmado!",
            text:"Tu pedido fue registrado correctamente üéâ",
            icon:"success",
            confirmButtonColor:"#e60073"
          });
          e.target.reset();
          state.cart=[]; btn.textContent="Confirmar pedido";
          setTimeout(()=>show('viewCatalog'),1500);
        } else {
          Swal.fire("Error",data.message||"No se pudo guardar","error");
        }
      }catch(err){
        Swal.fire("Error de red",err.toString(),"warning");
      }finally{
        btn.disabled=false;
        btn.textContent="Confirmar pedido";
      }
    });

    function show(id){
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    }

    document.getElementById('btnVolver').addEventListener('click',()=>show('viewCatalog'));
    init();
  </script>
</body>
</html>
