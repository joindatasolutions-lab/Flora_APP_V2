<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flora - Tienda de Flores</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --rosa:#e6a5b6; --rosa-osc:#c97b94; --bg:#fdfaf7; 
      --gris:#5c5c5c; --borde:#ecd6dc; --sombra:rgba(0,0,0,0.08);
    }
    *{ box-sizing:border-box; }
    body {
      margin:0; font-family:'Inter', sans-serif;
      background:var(--bg); color:#333; display:flex; flex-direction:column;
    }
    header{text-align:center;padding:20px 16px;}
    header img{max-width:220px;margin:0 auto 8px;display:block;}
    header h2{margin:8px 0 0;color:var(--gris);}
    .view{display:none;padding:16px;animation:fade .25s ease;}
    .view.active{display:block;}
    @keyframes fade{from{opacity:.35;transform:translateY(4px);}to{opacity:1;transform:none;}}

    /* === CAT√ÅLOGO === */
    .catalogo{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));max-width:1100px;margin:0 auto;}
    .card{
      background:#fff;border:1px solid var(--borde);border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);overflow:hidden;cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.09);}
    .card img{width:100%;height:auto;object-fit:cover;}
    .card .body{text-align:center;padding:12px;}
    .name{font-weight:700;font-size:.95rem;}
    .price{color:var(--gris);font-size:.9rem;margin-bottom:10px;}
    .btn-add{
      width:100%;padding:10px;border:none;border-radius:0 0 18px 18px;
      background:var(--rosa);color:#fff;font-weight:700;cursor:pointer;
    }

    /* === FORMULARIO === */
    form {
      background:#fff; border:1px solid var(--borde);
      border-radius:20px; max-width:800px; margin:20px auto;
      padding:28px; box-shadow:0 8px 24px var(--sombra);
    }
    h3 {
      border-bottom:2px solid var(--rosa);padding-bottom:6px;
      color:var(--rosa-osc);font-size:1.1rem;margin:20px 0 16px;
    }
    label{font-weight:600;color:#444;}
    input,select,textarea{
      width:100%;padding:10px 14px;border:1px solid #d9d9d9;
      border-radius:10px;font-size:.95rem;background:#fff;
      transition:border-color .25s ease, box-shadow .25s ease;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--rosa);box-shadow:0 0 0 3px rgba(230,165,182,0.2);outline:none;
    }
    textarea{min-height:90px;resize:vertical;}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));}
    .pedido-summary{
      background:#fff3f6;border:1px solid var(--borde);border-radius:12px;
      padding:10px 16px;margin-bottom:16px;font-weight:600;color:#a34b6d;
    }
    .actions{display:flex;justify-content:space-between;margin-top:20px;gap:12px;}
    .btn-primary{background:var(--rosa);color:#fff;border:none;border-radius:10px;padding:12px 22px;font-weight:800;cursor:pointer;}
    .btn-outline{background:#fff;border:2px solid var(--rosa);color:var(--rosa);border-radius:10px;padding:12px 22px;font-weight:700;cursor:pointer;}
    .btn-outline:hover{background:var(--rosa);color:#fff;}
    .firma-box{margin-top:10px;padding:10px 12px;border:1px dashed var(--rosa);border-radius:10px;background:#fff9fa;}
    .firma-box label{display:block;margin-bottom:6px;}
    .badge{
      display:inline-block;
      font-size:0.85rem;
      border-radius:999px;
      padding:4px 10px;
      margin-left:8px;
      vertical-align:middle;
    }
    .badge.ok{background:#e7f8ec;color:#137333;border:1px solid #b7e3c2;}
    .badge.warn{background:#fff7e6;color:#a15d00;border:1px solid #ffd59e;}
  </style>
</head>
<body>
  <header>
    <img src="img/logo 2024 marca registrada-04.png" alt="FLORA Logo"/>
    <h2>Cat√°logo de Arreglos Florales</h2>
  </header>

  <!-- === CAT√ÅLOGO === -->
  <section id="viewCatalog" class="view active">
    <div id="catalogo" class="catalogo"></div>
  </section>

  <!-- === FORMULARIO === -->
  <section id="viewForm" class="view">
    <form id="pedidoForm">
      <div class="pedido-summary" id="resumenProducto">üõç Producto: ‚Äî</div>

      <h3>Datos del Cliente 
        <span id="badgeCliente" class="badge warn">Nuevo cliente</span>
      </h3>

      <div class="grid">
        <div>
          <label>Tipo de identificaci√≥n</label>
          <select id="tipoIdent" name="tipoIdent" required>
            <option value="CEDULA" selected>C√©dula</option>
            <option value="NIT">NIT</option>
          </select>
        </div>
        <div>
          <label>Identificaci√≥n</label>
          <input id="identificacion" name="identificacion" required>
        </div>
        <div><label>Tel√©fono</label><input id="telefono" name="telefono" required></div>
        <div><label>Nombre</label><input id="primerNombre" name="primerNombre" required></div>
        <div><label>Apellido(s)</label><input id="primerApellido" name="primerApellido"></div>
        <div><label>Email (opcional)</label><input type="email" id="email" name="email"></div>
      </div>

      <h3>Entrega</h3>
      <div class="grid">
        <div><label>Destinatario</label><input id="destinatario" name="destinatario" required></div>
        <div><label>Tel√©fono destino</label><input id="telefonoDestino" name="telefonoDestino" required></div>
        <div><label>Direcci√≥n</label><input id="direccion" name="direccion" required></div>
        <div><label>Barrio</label><select id="barrio" name="barrio"></select></div>
        <div><label>Fecha de entrega</label><input id="fechaEntrega" type="date" name="fechaEntrega" required></div>
        <div><label>Hora de entrega</label><input id="horaEntrega" type="time" name="horaEntrega" required></div>
      </div>

      <h3>Pago y Mensaje</h3>
      <div class="grid">
        <div>
          <label>Medio de pago</label>
          <select id="formaPago" name="formaPago" required>
            <option value="">Selecciona‚Ä¶</option>
            <option value="TRANSFERENCIA">Transferencia</option>
            <option value="TARJETA">Tarjeta</option>
            <option value="LINK">Link</option>
            <option value="EFECTIVO">Efectivo</option>
            <option value="CUENTAS POR COBRAR">Cuentas Por Cobrar</option>
            <option value="CONTRAENTREGA">Contraentrega</option>
          </select>
        </div>
        <div class="grid-1">
          <label>Mensaje</label>
          <textarea id="mensaje" name="mensaje" placeholder="Escribe un mensaje opcional para acompa√±ar el arreglo"></textarea>
        </div>
      </div>

      <div class="firma-box">
        <label>¬øDeseas que el mensaje vaya firmado o an√≥nimo?</label>
        <select id="firmaMensaje" name="firmaMensaje" required>
          <option value="Firmado" selected>Firmado</option>
          <option value="An√≥nimo">An√≥nimo</option>
        </select>
        <div id="campoFirmaWrapper" style="margin-top:10px;">
          <label for="nombreFirma">Nombre para la firma</label>
          <input type="text" id="nombreFirma" name="nombreFirma" placeholder="Ej: Con cari√±o, Laura y Carlos">
        </div>
      </div>

      <input type="hidden" id="producto" name="producto">
      <input type="hidden" id="precio" name="precio">
      <input type="hidden" id="cantidad" name="cantidad">

      <div class="actions">
        <button type="button" class="btn-outline" id="btnVolver">Regresar</button>
        <button type="submit" class="btn-primary" id="btnSubmit">Confirmar pedido</button>
      </div>
    </form>
  </section>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwol802NzgXkLtWVJiDLX_MnOXlyyWxL0AnVVef1GO8L7TVYAI5uH_6jkJomakcWlih/exec";
    const state = { catalogo: [], barrios: {} };
    const fmtCOP = v => Number(v||0).toLocaleString('es-CO');

    async function init(){
      const res = await fetch(SCRIPT_URL);
      const data = await res.json();
      state.catalogo = data.catalogo || [];
      state.barrios = data.barrios || {};
      renderCatalog();
      fillBarrios();
    }

    // Render cat√°logo
    function renderCatalog(){
      const cont = document.getElementById("catalogo");
      cont.innerHTML = "";
      state.catalogo.forEach(prod=>{
        if(!prod.img) return;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${prod.img}" alt="${prod.name}">
          <div class="body">
            <div class="name">${prod.name}</div>
            <div class="price">$${fmtCOP(prod.price)}</div>
            <button class="btn-add">Seleccionar</button>
          </div>`;
        card.querySelector(".btn-add").addEventListener("click",()=>{
          document.getElementById("producto").value = prod.name;
          document.getElementById("precio").value = prod.price;
          document.getElementById("cantidad").value = 1;
          document.getElementById("resumenProducto").textContent = `üõç ${prod.name} ‚Äî $${fmtCOP(prod.price)}`;
          show("viewForm");
        });
        cont.appendChild(card);
      });
    }

    // Llenar barrios
    function fillBarrios(){
      const sel = document.getElementById("barrio");
      sel.innerHTML = '<option value="">Selecciona‚Ä¶</option>';
      Object.keys(state.barrios).forEach(b=>{
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        sel.appendChild(opt);
      });
    }

    // Detectar cliente existente
    document.getElementById("identificacion").addEventListener("blur", async (e)=>{
      const id = e.target.value.trim();
      if(!id) return;
      const badge = document.getElementById("badgeCliente");
      try{
        const res = await fetch(`${SCRIPT_URL}?accion=getCliente&id=${encodeURIComponent(id)}`);
        const data = await res.json();
        if(data && data.found){
          document.getElementById("tipoIdent").value = data.tipoIdent || "CEDULA";
          document.getElementById("telefono").value = data.telefono || "";
          document.getElementById("primerNombre").value = data.primerNombre || "";
          document.getElementById("primerApellido").value = data.primerApellido || "";
          document.getElementById("email").value = data.email || "";
          badge.textContent = "Cliente existente";
          badge.className = "badge ok";
        }else{
          badge.textContent = "Nuevo cliente";
          badge.className = "badge warn";
        }
      }catch(err){
        console.error("Error al obtener cliente:", err);
      }
    });

    // Mostrar/ocultar campo de firma
    document.getElementById("firmaMensaje").addEventListener("change", e=>{
      const campo = document.getElementById("campoFirmaWrapper");
      if(e.target.value === "Firmado"){
        campo.style.display = "block";
        document.getElementById("nombreFirma").required = true;
      }else{
        campo.style.display = "none";
        document.getElementById("nombreFirma").required = false;
        document.getElementById("nombreFirma").value = "";
      }
    });

    // Enviar pedido
    document.getElementById("pedidoForm").addEventListener("submit", async e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      try{
        const res = await fetch(SCRIPT_URL, { method:"POST", body:fd });
        const data = await res.json();
        if(data.status === "success"){
          Swal.fire("¬°Pedido confirmado!","Tu pedido fue registrado correctamente","success");
          e.target.reset();
          show("viewCatalog");
        }else{
          Swal.fire("Error",data.message || "No se pudo guardar","error");
        }
      }catch(err){
        Swal.fire("Error de conexi√≥n",err.message,"warning");
      }
    });

    // Mostrar vistas
    function show(id){
      document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      window.scrollTo({top:0,behavior:"smooth"});
    }
    document.getElementById("btnVolver").addEventListener("click",()=>show("viewCatalog"));

    init();
  </script>
</body>
</html>
