<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario Pedido</title>
  <style>
    body{font-family:sans-serif;background:#fdfaf7;margin:0}
    .view{display:none;padding:16px}
    .view.active{display:block}
    .btn-primary{background:#e6a5b6;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer}
    .btn-primary:hover{background:#c97b94}
    .btn-secondary{background:#ccc;color:#000;border:none;padding:10px 20px;border-radius:6px;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    #cart{position:fixed;top:0;right:0;width:350px;height:100%;background:#fff;box-shadow:-4px 0 12px rgba(0,0,0,.1);padding:16px;display:none;flex-direction:column;z-index:999}
    #cart.active{display:flex}
    #cartItems{flex:1;overflow-y:auto;margin-bottom:12px}
    #resumenProducto{background:#fbeaec;padding:10px;border-radius:6px;margin-bottom:16px}
  </style>
</head>
<body>
  <!-- Vista cat√°logo -->
  <section id="viewCatalog" class="view active">
    <h1>Cat√°logo</h1>
    <div id="catalogo"></div>
  </section>

  <!-- Vista formulario -->
  <section id="viewForm" class="view">
    <h2>Datos del Pedido</h2>
    <form id="pedidoForm">
      <div id="resumenProducto"></div>

      <div class="grid">
        <div>
          <label for="tipoIdent">Tipo de identificaci√≥n</label>
          <select id="tipoIdent" name="tipoIdent" required>
            <option value="CEDULA" selected>C√©dula</option>
            <option value="NIT">NIT</option>
          </select>
        </div>
        <div>
          <label for="identificacion">Identificaci√≥n</label>
          <input id="identificacion" name="identificacion" placeholder="Ej: 123456789 o 900123456-1" required>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="telefono">Tel√©fono</label>
          <input id="telefono" name="telefono" placeholder="Ej: 3001234567" required>
        </div>
        <div>
          <label for="nombre">Nombre</label>
          <input id="nombre" name="nombre" required>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="apellidos">Apellido(s)</label>
          <input id="apellidos" name="apellidos">
        </div>
        <div>
          <label for="telefonoDestino">Tel√©fono destino</label>
          <input id="telefonoDestino" name="telefonoDestino" placeholder="Ej: 3201234567">
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="destinatario">Destinatario</label>
          <input id="destinatario" name="destinatario">
        </div>
        <div>
          <label for="barrio">Barrio</label>
          <select id="barrio" name="barrio" required>
            <option value="">Seleccione‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="direccion">Direcci√≥n</label>
          <input id="direccion" name="direccion" placeholder="Direcci√≥n, Casa, Edificio, Torre, Apto">
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="fechaEntrega">Fecha de entrega</label>
          <input type="date" id="fechaEntrega" name="fechaEntrega" required>
        </div>
        <div>
          <label for="horaEntrega">Hora de entrega</label>
          <input type="time" id="horaEntrega" name="horaEntrega" required>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="medioPago">Medio de pago</label>
          <select id="medioPago" name="medioPago" required>
            <option value="">Seleccione‚Ä¶</option>
            <option value="TRANSFERENCIA">TRANSFERENCIA</option>
            <option value="TARJETA">TARJETA</option>
            <option value="LINK">LINK</option>
            <option value="EFECTIVO">EFECTIVO</option>
            <option value="CUENTAS POR COBRAR">CUENTAS POR COBRAR</option>
            <option value="CONTRAENTREGA">CONTRAENTREGA</option>
          </select>
        </div>
        <div>
          <label for="mensaje">Mensaje</label>
          <textarea id="mensaje" name="mensaje"></textarea>
        </div>
      </div>

      <!-- Campos ocultos -->
      <input type="hidden" id="producto" name="producto">
      <input type="hidden" id="precio" name="precio">
      <input type="hidden" id="cantidad" name="cantidad">
      <input type="hidden" id="iva" name="iva">
      <input type="hidden" id="domicilio" name="domicilio">

      <br>
      <button type="button" id="btnVolver" class="btn-secondary">Regresar al cat√°logo</button>
      <button type="submit" class="btn-primary">Procesar Pedido</button>
    </form>
    <div id="status"></div>
  </section>

  <!-- Carrito -->
  <div id="cart">
    <h2>Tu carrito</h2>
    <div id="cartItems"></div>
    <div id="cartSummary"></div>
    <div style="display:flex;gap:8px;">
      <button type="button" id="cartVaciar" class="btn-secondary">Vaciar</button>
      <button type="button" id="cartContinuar" class="btn-primary">Continuar</button>
    </div>
  </div>

  <button id="cartFab" style="position:fixed;bottom:16px;right:16px;">üõí</button>

  <script>
    const SCRIPT_URL="https://script.google.com/macros/s/AKfycbxQDmLKdSqxz_g3sSbLSJaECtrcK-y-fDRY43KUk3iI0CHGmJc5HT737PdWKevU5QzG4Q/exec";
    const state={cart:[],barrios:{}};

    function fmtCOP(n){return n.toLocaleString('es-CO');}

    function openCart(){document.getElementById('cart').classList.add('active');}
    function closeCart(){document.getElementById('cart').classList.remove('active');}

    function clearCart(){state.cart=[];renderCart();}

    function renderCart(){
      const cont=document.getElementById('cartItems');
      cont.innerHTML="";
      let subtotal=0;
      state.cart.forEach((i,idx)=>{
        subtotal+=i.price*i.qty;
        cont.innerHTML+=`
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <div>${i.name}<br>$${fmtCOP(i.price)}</div>
            <div>
              <button onclick="changeQty(${idx},-1)">-</button>
              ${i.qty}
              <button onclick="changeQty(${idx},1)">+</button>
            </div>
          </div>`;
      });
      document.getElementById('cartSummary').innerHTML=`<strong>Subtotal: $${fmtCOP(subtotal)}</strong>`;
    }

    function changeQty(idx,delta){
      state.cart[idx].qty+=delta;
      if(state.cart[idx].qty<=0) state.cart.splice(idx,1);
      renderCart();
    }

    function proceedToCheckout(){
      if(state.cart.length===0){closeCart();return;}
      let subtotal = state.cart.reduce((a,i)=>a+i.qty*i.price,0);
      const resumen = state.cart.map(i=>`${i.qty}√ó ${i.name}`).join(' | ');

      const tipoIdent = document.getElementById('tipoIdent').value;

      let iva = 0;
      if (tipoIdent === "NIT") {
        iva = subtotal * 0.19;
      }

      let domicilio = 0;
      const barrioSel = document.getElementById('barrio').value;
      if (state.barrios[barrioSel]) {
        domicilio = Number(state.barrios[barrioSel]) || 0;
      }

      const total = subtotal + iva + domicilio;

      let resumenHTML = `Carrito: ${resumen}<br>Subtotal: $${fmtCOP(subtotal)}`;
      if (tipoIdent === "NIT") resumenHTML += `<br>IVA (19%): $${fmtCOP(iva)}`;
      resumenHTML += `<br>Domicilio: $${fmtCOP(domicilio)}<br><strong>Total: $${fmtCOP(total)}</strong>`;

      document.getElementById('resumenProducto').innerHTML = resumenHTML;

      document.getElementById('producto').value = resumen;
      document.getElementById('precio').value = total;
      document.getElementById('cantidad').value = state.cart.reduce((a,i)=>a+i.qty,0);
      document.getElementById('iva').value = iva;
      document.getElementById('domicilio').value = domicilio;

      closeCart(); 
      show('viewForm');
    }

    function fillBarrios(barrios){
      state.barrios=barrios;
      const sel=document.getElementById('barrio');
      sel.innerHTML="<option value=''>Seleccione‚Ä¶</option>";
      for(const [nombre,val] of Object.entries(barrios)){
        sel.innerHTML+=`<option value="${nombre}">${nombre} ($${fmtCOP(val)})</option>`;
      }
    }

    function show(id){
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    window.onload = () => {
      document.getElementById('cartFab').onclick=openCart;
      document.getElementById('cartClose')?.onclick=closeCart;
      document.getElementById('cartVaciar').onclick=clearCart;
      document.getElementById('cartContinuar').onclick=proceedToCheckout;
      document.getElementById('btnVolver').onclick=()=>show('viewCatalog');

      document.getElementById('pedidoForm').onsubmit=async e=>{
        e.preventDefault();
        const fd=new FormData(e.target);
        document.getElementById('status').textContent="Enviando...";
        try{
          const res=await fetch(SCRIPT_URL,{method:"POST",body:fd});
          const out=await res.json();
          document.getElementById('status').textContent="‚úÖ Pedido enviado con √©xito";
          clearCart();
        }catch(err){
          console.error(err);
          document.getElementById('status').textContent="‚ùå Error al enviar el pedido";
        }
      };
    }
  </script>
</body>
</html>
