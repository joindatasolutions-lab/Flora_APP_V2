<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Flora - Tienda de Flores</title>
<style>
  :root{
    --rosa:#e6a5b6; --rosa-osc:#c97b94; --bg:#fdfaf7; --gris:#5c5c5c; --borde:#ecd6dc;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Georgia, serif; background:var(--bg); color:#333; display:flex; min-height:100vh; flex-direction:column}
  header{text-align:center; padding:20px 16px}
  header img{max-width:220px; height:auto; display:block; margin:0 auto 8px}
  header h2{margin:8px 0 0; color:var(--gris)}

  .view{display:none; padding:16px; animation:fade .25s ease}
  .view.active{display:block}
  @keyframes fade{from{opacity:.35; transform:translateY(4px)} to{opacity:1; transform:none}}

  .catalogo{display:grid; gap:18px; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); max-width:1100px; margin:0 auto}
  .card{
    background:#fff; border:1px solid var(--borde); border-radius:18px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    overflow:hidden; transition:transform .15s ease, box-shadow .15s ease, border-color .2s; cursor:pointer;
  }
  .card:hover{transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.09); border-color:var(--rosa)}
  .card.selected{outline:3px solid var(--rosa)}
  .card img{width:100%; height:170px; object-fit:cover; border-bottom:1px solid var(--borde); filter:saturate(1.02)}
  .card .body{padding:12px 14px 16px; text-align:center}
  .name{font-weight:700; margin:6px 0 2px}
  .price{color:var(--gris); margin:0}

  .actions{max-width:1100px; margin:18px auto 8px; display:flex; justify-content:center; gap:12px}
  .btn{
    appearance:none; border:none; border-radius:10px; padding:12px 18px; font-weight:700; cursor:pointer;
    background:var(--rosa); color:#fff; box-shadow:0 6px 14px rgba(230,165,182,.35); transition:background .2s ease, transform .05s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{filter:grayscale(.5); opacity:.6; cursor:not-allowed}

  form{background:#fff; border:1px solid var(--borde); border-radius:16px; max-width:760px; margin:0 auto; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.06)}
  form h3{margin:0 0 14px; color:var(--gris)}
  .grid{display:grid; gap:12px; grid-template-columns:repeat(2,1fr)}
  .grid-1{grid-template-columns:1fr}
  label{font-size:.92rem; color:#444}
  input, select, textarea{width:100%; padding:10px 12px; border:1px solid #d9d9d9; border-radius:10px; font-size:14px; background:#fff}
  input:focus, select:focus, textarea:focus{outline:2px solid var(--rosa); border-color:var(--rosa)}
  textarea{min-height:80px; resize:vertical}
  .muted{color:#777; font-size:.9rem}
  .pill{display:inline-block; padding:8px 12px; border-radius:999px; background:#fff3f6; border:1px solid var(--rosa); margin:0 0 10px; color:#b35a74; font-weight:700}
  #status{text-align:center; margin-top:10px; font-weight:700}
  .ok{color:green} .err{color:#b00020}
  /* Ocultamos los inputs de cálculo */
  .hidden{display:none !important}
</style>
</head>
<body>
<header>
  <img src="img/logo 2024 marca registrada-04.png" alt="FLORA Logo"/>
  <h2>Catálogo de Arreglos Florales</h2>
</header>

<!-- VISTA 1: Catálogo -->
<section id="viewCatalog" class="view active">
  <div id="catalogo" class="catalogo"></div>
  <div class="actions">
    <button id="btnContinuar" class="btn" disabled>Continuar</button>
  </div>
</section>

<!-- VISTA 2: Formulario -->
<section id="viewForm" class="view">
  <form id="pedidoForm">
    <span class="pill" id="resumenProducto">Producto: —</span>
    <h3>Datos del Pedido</h3>

    <!-- Campos ocultos para envío al backend -->
    <input type="hidden" name="producto" id="producto">
    <input type="hidden" name="precio"   id="precio">
    <input type="hidden" name="domicilio" id="domicilio">
    <input type="hidden" name="total"    id="total">
    <input type="hidden" name="cantidad" value="1"> <!-- fijo en 1 (ajustable si lo necesitas) -->

    <div class="grid">
      <div><label>Identificación</label><input name="identificacion" required></div>
      <div><label>Teléfono</label><input name="telefono" type="tel" required></div>

      <div><label>Primer Nombre</label><input name="primerNombre" required></div>
      <div><label>Segundo Nombre</label><input name="segundoNombre"></div>

      <div><label>Primer Apellido</label><input name="primerApellido" required></div>
      <div><label>Segundo Apellido</label><input name="segundoApellido"></div>

      <div><label>Forma de Pago</label>
        <select name="formaPago" required>
          <option value="">Selecciona…</option>
          <option>Efectivo</option>
          <option>Transferencia</option>
          <option>Tarjeta</option>
        </select>
      </div>
      <div><label>Fecha de Entrega</label><input name="fechaEntrega" type="date" required></div>

      <div><label>Destinatario</label><input name="destinatario" required></div>
      <div><label>Teléfono destino</label><input name="telefonoDestino" type="tel" required></div>

      <div><label>Barrio</label>
        <select name="barrio" id="barrio" required>
          <option value="">Selecciona…</option>
          <!-- opciones se cargan desde hoja Barrio -->
        </select>
      </div>
      <div class="grid-1"><label>Dirección</label><input name="direccion" required></div>

      <div class="grid-1">
        <label>Total a pagar (incluye domicilio)</label>
        <div id="labelTotal" class="pill">—</div>
      </div>

      <div class="grid-1">
        <label>Mensaje para la tarjeta <span class="muted">(opcional)</span></label>
        <textarea name="mensaje" placeholder="Escribe aquí tu dedicatoria…"></textarea>
      </div>
    </div>

    <div class="actions" style="margin-top:14px">
      <button type="button" class="btn" id="btnVolver">← Catálogo</button>
      <button type="submit" class="btn">Confirmar pedido</button>
    </div>
    <div id="status"></div>
  </form>
</section>

<script>
  // Reemplaza con la URL del WebApp de Apps Script (termina en /exec)
  const SCRIPT_URL = "PEGAR_AQUI_TU_URL_EXEC";

  let state = {
    selected: null,  // {id, name, price, img}
    barrios: {}      // { "Miramar": 10000, ... }
  };

  const fmtCOP = v => Number(v || 0).toLocaleString('es-CO');

  // ---------- Cargar catálogo y barrios (un solo fetch) ----------
  async function init() {
    try {
      const res = await fetch(SCRIPT_URL);
      const { catalogo, barrios } = await res.json();
      state.barrios = barrios || {};
      renderCatalog(catalogo || []);
      fillBarrios(barrios || {});
    } catch (e) {
      document.getElementById('catalogo').innerHTML =
        "<p>Error cargando datos. Revisa la URL del WebApp.</p>";
    }
  }

  function renderCatalog(items) {
    const wrap = document.getElementById('catalogo');
    wrap.innerHTML = "";
    items.forEach(prod => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img src="${prod.img}" alt="${prod.name}">
        <div class="body">
          <div class="name">${prod.name}</div>
          <p class="price">$${fmtCOP(prod.price)}</p>
        </div>
      `;
      card.addEventListener('click', () => selectProduct(card, prod));
      wrap.appendChild(card);
    });
  }

  function selectProduct(card, prod) {
    document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    state.selected = prod;

    document.getElementById('btnContinuar').disabled = false;
  }

  function fillBarrios(dict) {
    const sel = document.getElementById('barrio');
    sel.innerHTML = '<option value="">Selecciona…</option>';
    Object.keys(dict).forEach(nombre => {
      const opt = document.createElement('option');
      opt.value = nombre;
      opt.textContent = `${nombre}`;
      sel.appendChild(opt);
    });
  }

  // ---------- Navegación ----------
  function show(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo({top:0, behavior:'smooth'});
  }

  document.getElementById('btnContinuar').addEventListener('click', () => {
    if (!state.selected) return; // bloqueo extra
    // Setear campos ocultos e info visible
    document.getElementById('producto').value = state.selected.name;
    document.getElementById('precio').value   = Number(state.selected.price || 0);
    document.getElementById('resumenProducto').textContent =
      `Producto: ${state.selected.name} — $${fmtCOP(state.selected.price)}`;

    // limpiar total/dom antes de calcular
    document.getElementById('domicilio').value = 0;
    document.getElementById('total').value     = 0;
    document.getElementById('labelTotal').textContent = "—";

    show('viewForm');
  });

  document.getElementById('btnVolver').addEventListener('click', () => {
    show('viewCatalog');
  });

  // ---------- Cálculo de total (precio + domicilio por barrio) ----------
  document.getElementById('barrio').addEventListener('change', () => {
    const precio = Number(document.getElementById('precio').value || 0);
    const barrio = document.getElementById('barrio').value;
    const dom    = Number(state.barrios[barrio] || 0);
    const total  = precio + dom;

    document.getElementById('domicilio').value = dom;
    document.getElementById('total').value     = total;
    document.getElementById('labelTotal').textContent =
      total ? `Total a pagar: $${fmtCOP(total)} (incluye domicilio)` : "—";
  });

  // ---------- Envío ----------
  document.getElementById('pedidoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const status = document.getElementById('status');

    if (!state.selected) {
      show('viewCatalog');
      status.textContent = "Selecciona un producto antes de continuar.";
      status.className = "err";
      return;
    }
    if (!document.getElementById('barrio').value) {
      status.textContent = "Debes seleccionar el barrio.";
      status.className = "err";
      return;
    }
    // Validar que ya se haya calculado total
    if (!document.getElementById('total').value) {
      status.textContent = "Selecciona el barrio para calcular el total.";
      status.className = "err";
      return;
    }

    const payload = Object.fromEntries(new FormData(e.target).entries());

    try {
      const resp = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const out = await resp.json();
      if (out.status === "success") {
        status.textContent = "✅ ¡Pedido registrado con éxito!";
        status.className = "ok";
        e.target.reset();
        state.selected = null;
      } else {
        status.textContent = "❌ Error: " + (out.message || "No se pudo registrar.");
        status.className = "err";
      }
    } catch (err) {
      status.textContent = "❌ Error de conexión.";
      status.className = "err";
    }
  });

  // Init
  init();
</script>
</body>
</html>
