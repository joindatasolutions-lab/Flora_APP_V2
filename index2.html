<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<title>Flora - Tienda de Flores</title>
<style>
  :root{ --rosa:#e6a5b6; --rosa-osc:#c97b94; --bg:#fdfaf7; --gris:#5c5c5c; --borde:#ecd6dc; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:'Inter', sans-serif; background:var(--bg); color:#333; display:flex; min-height:100vh; flex-direction:column }
  header{ text-align:center; padding:20px 16px }
  header img{ max-width:220px; height:auto; display:block; margin:0 auto 8px }
  header h2{ margin:8px 0 0; color:var(--gris) }
  .view{ display:none; padding:16px; animation:fade .25s ease }
  .view.active{ display:block }
  @keyframes fade{ from{ opacity:.35; transform:translateY(4px) } to{ opacity:1; transform:none } }

  /* CatÃ¡logo */
  .catalogo{ 
    display:grid; 
    gap:12px; 
    grid-template-columns:repeat(2,1fr);
    max-width:1100px; margin:0 auto 
  }
  @media(min-width:768px){ .catalogo{ grid-template-columns:repeat(3,1fr); } }
  @media(min-width:1024px){ .catalogo{ grid-template-columns:repeat(4,1fr); } }
  .card{
    background:#fff; border:1px solid var(--borde); border-radius:18px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    overflow:hidden; transition:transform .15s ease, box-shadow .15s ease, border-color .2s; cursor:pointer;
    display:flex; flex-direction:column; align-items:center; padding:10px;
    position: relative; 
  }
  .card:hover{ transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.09); border-color:var(--rosa) }
  .card.selected{ outline:3px solid var(--rosa) }
  .card img{ width:100%; height:auto; object-fit:contain; border-bottom:1px solid var(--borde); filter:saturate(1.02) }
  .card .body{ padding:8px; text-align:center; flex-grow:1;padding-bottom: 64px; }
  .name{ font-weight:700; margin:6px 0 2px; font-size:.9rem }
  .price{ color:var(--gris); margin:0; font-size:.9rem }
  .btn-add{
    position:absolute; left:0; bottom:0; width:100%;
    margin:0; padding:12px 0; font-size:.95rem; letter-spacing:.2px;
    border:none; border-radius:0 0 18px 18px;
    background:var(--rosa); color:#fff; font-weight:700; cursor:pointer;
    transition:filter .2s ease, transform .05s ease;
  }
  .btn-add:hover{ filter:brightness(.95); }
  .btn-add:active{ transform:translateY(1px); }

  /* Formulario */
  form{ background:#fff; border:1px solid var(--borde); border-radius:16px; max-width:780px; margin:0 auto; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.06) }
  form h3{ margin:0 0 14px; color:var(--gris) }
  .grid{ display:grid; gap:12px; grid-template-columns:repeat(2,1fr) }
  .grid-1{ grid-template-columns:1fr }
  label{ font-size:.92rem; color:#444 }
  input, select, textarea{ width:100%; padding:10px 12px; border:1px solid #d9d9d9; border-radius:10px; font-size:14px; background:#fff }
  input:focus, select:focus, textarea:focus{ outline:2px solid var(--rosa); border-color:var(--rosa) }
  textarea{ min-height:80px; resize:vertical }
  .pill{ display:inline-block; padding:8px 12px; border-radius:999px; background:#fff3f6; border:1px solid var(--rosa); margin:0 0 10px; color:#b35a74; font-weight:700 }
  .badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-size:.85rem; margin-left:8px }
  .ok{ background:#e7f8ec; color:#1a7f37; border:1px solid #bfe7c8 }
  .warn{ background:#fff7e6; color:#a15d00; border:1px solid #ffd59e }
  #status{ text-align:center; margin-top:10px; font-weight:700 }
  .err{ color:#b00020 } .good{ color:green }

  /* Modal */
  .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.45); justify-content:center; align-items:center; }
  .modal-content { background:#fff; padding:25px; border-radius:16px; text-align:center; width:340px; box-shadow:0 6px 20px rgba(0,0,0,0.25); border:2px solid var(--rosa); }
  .modal-content h2 { color:var(--rosa-osc); margin-bottom:12px; }
  .modal-content p { margin-bottom:18px; color:var(--gris); font-weight:600; }
  .modal-content button { margin:6px; padding:10px 18px; border:none; border-radius:10px; cursor:pointer; font-weight:700; }
  .btn-salir { background:#5c5c5c; color:#fff; }
</style>
</head>
<body>
<header>
  <img src="img/logo 2024 marca registrada-04.png" alt="FLORA Logo"/>
  <h2>CatÃ¡logo de Arreglos Florales</h2>
</header>

<!-- VISTA 1 -->
<section id="viewCatalog" class="view active">
  <div id="catalogo" class="catalogo"></div>
</section>

<!-- VISTA 2 -->
<section id="viewForm" class="view">
  <form id="pedidoForm" novalidate>
    <span class="pill" id="resumenProducto">Producto: â€”</span>
    <span id="badgeCliente" class="badge warn hidden">Nuevo cliente</span>
    <h3>Datos del Pedido</h3>

    <input type="hidden" name="producto" id="producto">
    <input type="hidden" name="precio"   id="precio">
    <input type="hidden" name="domicilio" id="domicilio">
    <input type="hidden" name="total"    id="total">
    <input type="hidden" name="cantidad" value="1">

    <div class="grid">
      <div><label>IdentificaciÃ³n</label><input name="identificacion" id="identificacion" required /></div>
      <div><label>TelÃ©fono</label><input name="telefono" id="telefono" type="tel" required /></div>
      <div><label>Nombre</label><input name="primerNombre" id="primerNombre" required /></div>
      <div><label>Apellidos</label><input name="primerApellido" id="primerApellido" required /></div>
      <div><label>Forma de Pago</label>
        <select name="formaPago" required>
          <option value="">Seleccionaâ€¦</option><option>Efectivo</option><option>Transferencia</option>
          <option>Tarjeta</option><option>Link</option><option>Contraentrega</option>
        </select>
      </div>
      <div><label>Fecha de Entrega</label><input name="fechaEntrega" id="fechaEntrega" type="date" required /></div>
      <div><label>Hora de Entrega</label><input name="horaEntrega" id="horaEntrega" type="time" required step="900" /></div>
      <div><label>Destinatario</label><input name="destinatario" id="destinatario" required /></div>
      <div><label>TelÃ©fono destino</label><input name="telefonoDestino" id="telefonoDestino" type="tel" required /></div>
      <div><label>Barrio</label><select name="barrio" id="barrio" required><option value="">Seleccionaâ€¦</option></select></div>
      <div class="grid-1"><label>DirecciÃ³n</label><input name="direccion" id="direccion" required /></div>
      <div class="grid-1"><label>Total a pagar (incluye domicilio)</label><div id="labelTotal" class="pill">â€”</div></div>
      <div class="grid-1"><label>Mensaje <span class="muted">(opcional)</span></label><textarea name="mensaje" id="mensaje"></textarea></div>
    </div>

    <div class="actions" style="margin-top:14px">
      <button type="button" class="btn btn-outline" id="btnVolver">Volver a CatÃ¡logo</button>
      <button type="submit" class="btn">Confirmar pedido</button>
    </div>


    <div id="status"></div>
    
  </form>
</section>

<!-- Modal -->
<div id="modalExito" class="modal">
  <div class="modal-content">
    <h2>âœ… Pedido registrado con Ã©xito</h2>
    <p>Â¿Desea hacer otro pedido o salir?</p>
    <button onclick="nuevoPedido()">ðŸ›’ Hacer otro pedido</button>
    <button class="btn-salir" onclick="salir()">ðŸšª Salir</button>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwW2TpbWuBO0kpE1wYnz9Eizyeus3KcMwVeO0fgp6EdBFZvo9JYsH0J9IZL_zRGlBQ/exec";
const state = { selected: null, barrios: {} };
const fmtCOP = v => Number(v || 0).toLocaleString('es-CO');

async function init() {
  try {
    const res = await fetch(SCRIPT_URL);
    const { catalogo, barrios } = await res.json();
    state.barrios = barrios || {};
    renderCatalog(catalogo || []);
    fillBarrios(barrios || {});
    const hoy = new Date().toISOString().slice(0,10);
    document.getElementById('fechaEntrega').setAttribute('min', hoy);
  } catch (e) {
    document.getElementById('catalogo').innerHTML = "<p>Error cargando datos. Revisa la URL del WebApp.</p>";
  }
}

function renderCatalog(items) {
  const wrap = document.getElementById('catalogo');
  wrap.innerHTML = "";
  items.forEach(prod => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img src="${prod.img}" alt="${prod.name}">
      <div class="body">
        <div class="name">${prod.name}</div>
        <p class="price">$${fmtCOP(prod.price)}</p>
        <button class="btn-add">AÃ±adir</button>
      </div>`;
    card.querySelector('.btn-add').addEventListener('click', ev => {
      ev.stopPropagation(); selectProduct(card, prod);
      document.getElementById('btnContinuar').click();
    });
    card.addEventListener('click', () => selectProduct(card, prod));
    wrap.appendChild(card);
  });
}

function selectProduct(card, prod) {
  document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
  card.classList.add('selected'); state.selected = prod;
  document.getElementById('producto').value = prod.name;
  document.getElementById('precio').value = Number(prod.price || 0);
  document.getElementById('resumenProducto').textContent =
    `Producto: ${prod.name} â€” $${fmtCOP(prod.price)}`;
  show('viewForm');
}

function fillBarrios(dict) {
  const sel = document.getElementById('barrio');
  sel.innerHTML = '<option value="">Seleccionaâ€¦</option>';
  Object.keys(dict).forEach(nombre => {
    const opt = document.createElement('option');
    opt.value = nombre; opt.textContent = nombre;
    sel.appendChild(opt);
  });
}

function show(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({ top:0, behavior:'smooth' });
}
document.getElementById('btnVolver').addEventListener('click', () => show('viewCatalog'));

document.getElementById('barrio').addEventListener('change', calcularTotal);
function calcularTotal() {
  const precio = Number(document.getElementById('precio').value || 0);
  const barrio = document.getElementById('barrio').value;
  const dom = Number(state.barrios[barrio] || 0);
  const total = precio + dom;
  document.getElementById('domicilio').value = dom;
  document.getElementById('total').value = total;
  document.getElementById('labelTotal').textContent =
    barrio ? `Total: $${fmtCOP(total)} (incluye domicilio)` : "â€”";
}

document.getElementById('pedidoForm').addEventListener('submit', async e => {
  e.preventDefault(); const status = document.getElementById('status');
  if (!state.selected) { show('viewCatalog'); return; }
  if (!document.getElementById('barrio').value) {
    status.textContent = "Selecciona barrio."; status.className = "err"; return;
  }
  try {
    const fd = new FormData(e.target);
    // --- NUEVO: concatenar fecha + hora ---
    const fecha = document.getElementById('fechaEntrega').value;
    const hora  = document.getElementById('horaEntrega').value;
    if (fecha && hora) {
      fd.set('fechaEntrega', `${fecha} ${hora}`);
      // Ã³ ISO: fd.set('fechaEntrega', `${fecha}T${hora}:00`);
    }
    const resp = await fetch(SCRIPT_URL, { method: "POST", body: fd });
    const out = await resp.json();
    if (out.status === "success") {
      document.getElementById("modalExito").style.display = "flex";
      e.target.reset();
    } else {
      status.textContent = "âŒ Error: " + (out.message || "No se pudo registrar."); status.className = "err";
    }
  } catch (err) { status.textContent = "âŒ Error de conexiÃ³n."; status.className = "err"; }
});

// ---------- BÃºsqueda y autorrelleno de cliente por IdentificaciÃ³n (con debounce) ----------
let lookupTimer = null;

document.getElementById('identificacion').addEventListener('input', (e) => {
  clearTimeout(lookupTimer);
  const val = e.target.value.trim();
  if (!val) { setClienteBadge(null); return; }
  lookupTimer = setTimeout(() => buscarCliente(val), 400); // espera 400 ms
});

async function buscarCliente(ident) {
  try {
    // El WebApp debe responder a ?cliente=IDENT con { cliente: { ... } } si existe
    const res  = await fetch(`${SCRIPT_URL}?cliente=${encodeURIComponent(ident)}`);
    const data = await res.json();

    if (data && data.cliente) {
      setClienteBadge(true);
      autofillCliente(data.cliente);
    } else {
      setClienteBadge(false);
      limpiarCliente(false);
    }
  } catch (err) {
    setClienteBadge(null);
    console.error('Lookup cliente error:', err);
  }
}

function setClienteBadge(encontrado) {
  const b = document.getElementById('badgeCliente');
  b.classList.remove('hidden', 'ok', 'warn');
  if (encontrado === true) {
    b.textContent = "Cliente encontrado";
    b.classList.add('ok');
  } else if (encontrado === false) {
    b.textContent = "Nuevo cliente";
    b.classList.add('warn');
  } else {
    b.classList.add('hidden');
  }
}

// NOTE: index.html separa nombres y apellidos en 4 campos.
// En index2.html tienes un solo campo para nombre y otro para apellidos,
// asÃ­ que combinamos segundo nombre/apellido si existen.
function autofillCliente(c) {
  const nombre =
    [c.PrimerNombre, c.SegundoNombre].filter(Boolean).join(' ').trim();
  const apellidos =
    [c.PrimerApellido, c.SegundoApellido].filter(Boolean).join(' ').trim();

  document.getElementById('primerNombre').value   = nombre || "";
  document.getElementById('primerApellido').value = apellidos || "";
  document.getElementById('telefono').value       = c.Telefono || "";
  // Barrio y DirecciÃ³n quedan para que el usuario los indique segÃºn el envÃ­o
}

function limpiarCliente(clearId) {
  if (clearId) document.getElementById('identificacion').value = "";
  document.getElementById('primerNombre').value   = "";
  document.getElementById('primerApellido').value = "";
  document.getElementById('telefono').value       = "";
}



function nuevoPedido(){ document.getElementById("modalExito").style.display="none"; show('viewCatalog'); }
function salir(){ window.location.href="https://joindatasolutions-lab.github.io/Flora_APP_V2/"; }

init();
</script>
</body>
</html>
