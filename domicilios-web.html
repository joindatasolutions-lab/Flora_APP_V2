<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flora - Panel de Domicilios</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --rosa: #E6A5B6;
      --rosa-osc: #C97B94;
      --verde: #4C7C62;
      --beige: #FAF6F3;
      --gris: #5C5C5C;
      --borde: #EBD8DB;
      --hover: #B5647B;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--beige);
      margin: 0;
      color: #333;
    }

    header {
      text-align: center;
      background: #fff;
      padding: 20px;
      border-bottom: 1px solid var(--borde);
      box-shadow: 0 2px 6px rgba(0, 0, 0, .05);
    }

    header img {
      max-width: 180px;
      margin-bottom: 8px;
    }

    header h2 {
      color: var(--rosa-osc);
      font-weight: 700;
      margin: 0;
    }

    main {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 25px;
      padding: 25px;
      justify-items: center;
    }

    .card {
      background: #fff;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      transition: all 0.25s ease;
      width: 100%;
      max-width: 380px;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .encabezado {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #FFF8FA;
      padding: 10px 18px;
      border-bottom: 1px solid var(--borde);
    }

    .pedido-num {
      font-weight: 700;
      font-size: 1em;
      color: var(--rosa-osc);
    }

    .estado {
      font-weight: 600;
      padding: 5px 12px;
      border-radius: 12px;
      font-size: .9em;
      color: #fff;
      text-transform: capitalize;
    }

    .pendiente { background: var(--rosa); }
    .en_ruta { background: var(--rosa-osc); }
    .entregado { background: var(--verde); }

    .img-card {
      width: 100%;
      height: 240px;
      object-fit: cover;
      transition: transform .3s;
      background: #fff;
    }

    .card:hover .img-card {
      transform: scale(1.03);
    }

    .detalle {
      padding: 14px 20px;
      flex: 1;
    }

    .detalle h3 {
      margin: 4px 0 10px;
      font-size: 1.1em;
      color: var(--rosa-osc);
    }

    .detalle p {
      margin: 4px 0;
      font-size: .9em;
      color: var(--gris);
    }

    .detalle strong {
      color: #222;
    }

    .acciones {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px 18px;
    }

    select {
      flex: 1;
      border: 1px solid var(--borde);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: .9em;
      background: #fff;
    }

    .btn-estado {
      border: none;
      padding: 10px 22px;
      border-radius: 10px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      transition: .2s;
      background: var(--rosa-osc);
      font-size: .95em;
    }

    .btn-estado:hover {
      background: var(--hover);
    }

    .btn-estado.entregado {
      background: var(--verde);
    }

    .btn-estado.entregado:hover {
      background: #3A614E;
    }

    footer {
      text-align: center;
      color: var(--gris);
      padding: 18px;
      font-size: .85em;
    }

    /* ðŸŒ¸ Toast de notificaciÃ³n */
    #toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--rosa-osc);
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      font-weight: 600;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease, transform 0.4s ease;
      z-index: 1000;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ðŸ“± Responsive */
    @media (max-width: 768px) {
      main { grid-template-columns: 1fr; padding: 12px; }
      .card { max-width: 100%; }
      .img-card { height: 210px; }
      .acciones { flex-direction: column; gap: 10px; }
      .btn-estado, select { width: 100%; }
    }
  </style>
</head>

<body>
  <header>
    <img src="https://floraapp.s3.us-east-1.amazonaws.com/logo+2024+marca+registrada-04.png" alt="Flora Logo">
    <h2>Panel de Domicilios</h2>
  </header>

  <main id="contenedor-domicilios">
    <p style="text-align:center;">Cargando pedidos...</p>
  </main>

  <footer>ðŸŒ¸ Flora App - GestiÃ³n de Domicilios</footer>

  <div id="toast">âœ… Estado actualizado correctamente</div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzuw8pbOSLTYAop9lRY8U44lF_eoWJLAgBxWUbzx8FiGTa3N5vT7CvaGnb_Ykdy0fd/exec";
    

    function mostrarToast(msg = "âœ… Estado actualizado correctamente") {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    async function cargarDomicilios() {
      try {
        const res = await fetch(`${SCRIPT_URL}?hoja=Domicilios`, {
          method: 'GET',
          cache: 'no-store'
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        renderizarDomicilios(data);  // ðŸŸ¢ <--- agrega esta lÃ­nea
      } catch (err) {
        console.error('Error cargando domicilios:', err);
      }
    }

    async function actualizarEstado(pedido, nuevoEstado, boton, badge) {
      boton.disabled = true;
      boton.textContent = "Actualizando...";

      try {
        const body = new URLSearchParams({
          accion: 'actualizarEstado',
          hoja: 'Domicilios',
          pedido: String(pedido),
          estado: nuevoEstado
        });

        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body,
          cache: 'no-store'
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        // ðŸŸ¢ Verificamos que la respuesta sea JSON vÃ¡lida
        const text = await res.text();
        let data = {};
        try {
          data = JSON.parse(text);
        } catch {
          throw new Error("Respuesta no es JSON vÃ¡lida: " + text);
        }

        // ðŸŸ¢ Validamos la respuesta
        if (data.result === "ok" || data.status === "success") {
          if (nuevoEstado === "En Ruta") {
            boton.textContent = "Entregado";
            boton.classList.add("entregado");
            badge.textContent = "En Ruta";
            badge.className = "estado en_ruta";
            mostrarToast("ðŸšš Pedido en ruta");
          } else {
            boton.textContent = "Entregado âœ…";
            badge.textContent = "Entregado";
            badge.className = "estado entregado";
            mostrarToast("âœ… Pedido entregado");
          }
        } else {
          console.warn("âš ï¸ Respuesta inesperada:", data);
          boton.textContent = "Error";
          mostrarToast("âš ï¸ No se pudo actualizar el estado");
        }

      } catch (e) {
        console.error("âŒ Error actualizando:", e);
        boton.textContent = "Error";
        mostrarToast("âŒ Error de conexiÃ³n con el servidor");
      } finally {
        boton.disabled = false;
      }
    }

    function renderizarDomicilios(domicilios) {
      const contenedor = document.getElementById("contenedor-domicilios");
      contenedor.innerHTML = "";

      if (!domicilios?.length) {
        contenedor.innerHTML = `<p style="text-align:center;">No hay pedidos registrados.</p>`;
        return;
      }

      domicilios.forEach(dom => {
        const numeroPedido = dom["NÂ°Pedido"] || dom.pedido || dom.numero || "â€”";
        const estado = dom.estado || "Pendiente";
        const estadoClase = estado.toLowerCase().replace(" ", "_");
        const textoBoton = estado === "Pendiente" ? "En Ruta" :
                           estado === "En Ruta" ? "Entregado" : "Entregado âœ…";
        const claseBoton = estado === "Entregado" ? "btn-estado entregado" : "btn-estado";

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="encabezado">
            <div class="pedido-num">Pedido #${numeroPedido}</div>
            <div class="estado ${estadoClase}">${estado}</div>
          </div>
          <img src="${dom.imagen}" alt="${dom.producto}" class="img-card" />
          <div class="detalle">
            <h3>${dom.producto}</h3>
            <p><strong>Destinatario:</strong> ${dom.destinatario || "â€”"}</p>
            <p><strong>DirecciÃ³n:</strong> ${dom.direccion || "â€”"}</p>
            <p><strong>Barrio:</strong> ${dom.barrio || "â€”"}</p>
            <p><strong>TelÃ©fono:</strong> ${dom.telefonoDestino || dom.telefono || "â€”"}</p>
            <p><strong>Entrega:</strong> ${dom.fechaEntrega || ""}</p>
          </div>
          <div class="acciones">
            <select>
              <option value="">Asignar domiciliario</option>
              <option ${dom.domiciliario==="Elvis"?"selected":""}>Elvis</option>
              <option ${dom.domiciliario==="Oscar"?"selected":""}>Oscar</option>
              <option ${dom.domiciliario==="Externo"?"selected":""}>Externo</option>
            </select>
            <button class="${claseBoton}">${textoBoton}</button>
          </div>
        `;

        const boton = card.querySelector("button");
        const badge = card.querySelector(".estado");

        boton.addEventListener("click", () => {
          const nuevoEstado = badge.textContent === "Pendiente" ? "En Ruta" :
                              badge.textContent === "En Ruta" ? "Entregado" : "Entregado";
          actualizarEstado(numeroPedido, nuevoEstado, boton, badge);
        });

        contenedor.appendChild(card);
      });
    }

    cargarDomicilios();
  </script>
</body>
</html>
